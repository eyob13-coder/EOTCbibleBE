name: Healthcheck Monitor

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    env:
      HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
      ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}
    steps:
      - name: Validate healthcheck config
        run: |
          if [ -z "${HEALTHCHECK_URL}" ]; then
            echo "Missing secret: HEALTHCHECK_URL"
            exit 1
          fi

      - name: Check API health
        id: check
        run: |
          set -euo pipefail
          status_code=$(curl -sS -o health.json -w "%{http_code}" "${HEALTHCHECK_URL}")
          echo "status_code=${status_code}" >> "$GITHUB_OUTPUT"

          if [ "${status_code}" -ne 200 ]; then
            echo "Health endpoint returned ${status_code}"
            cat health.json || true
            exit 1
          fi

          if ! grep -q '"status":"OK"' health.json; then
            echo "Health endpoint payload is not OK"
            cat health.json || true
            exit 1
          fi

      - name: Alert webhook on failure
        if: failure() && env.ALERT_WEBHOOK_URL != ''
        run: |
          payload=$(cat <<EOF
          {
            "text": "Healthcheck failed for ${HEALTHCHECK_URL}. Workflow: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          }
          EOF
          )
          curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "${ALERT_WEBHOOK_URL}"
